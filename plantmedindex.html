<!DOCTYPE html>
<html>
<head>
    <title>Plant Medicinal Identifier</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <!-- Load tmImage from correct CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #4CAF50;
        }
        #webcam-container {
            margin: 20px auto;
            width: 400px;
            height: 400px;
            border: 3px solid #4CAF50;
            border-radius: 5px;
            position: relative;
            background-color: #ddd;
        }
        #label-container {
            margin: 20px;
            font-size: 18px;
        }
        #medicinal-info {
            margin: 20px auto;
            max-width: 600px;
            padding: 15px;
            border-radius: 5px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: left;
        }
        #start-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 5px;
        }
        #camera-error {
            color: red;
            font-weight: bold;
            margin: 20px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .precaution-high {
            background-color: #ffdddd;
            border-left: 5px solid #f44336;
        }
        .precaution-moderate {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
        }
        .plant-name {
            font-weight: bold;
            color: #4CAF50;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <h1>ðŸŒ¿ Plant Medicinal Identifier ðŸ’Š</h1>
    <button id="start-button">Start Camera</button>
    <div id="camera-error"></div>
    <div id="webcam-container"></div>
    <div id="label-container"></div>
    <div id="medicinal-info"></div>

    <script>
        // Check if tmImage is loaded
        if (typeof tmImage === 'undefined') {
            document.getElementById("camera-error").textContent = 
                "Failed to load AI model. Please check your internet connection and reload the page.";
        }

        // Medicinal Database
        const plantDB = {
            "Mango Tree": {
                uses: [
                    "The unripe mango and mango leaves are used in traditional medicine to improve digestion, relieve constipation, and treat gastrointestinal issues",
                    "Mango leaves contain compounds like mangiferin, which have anti-inflammatory and antioxidant effects, helping to reduce inflammation and oxidative stress in the body",
                    "Mango leaves are used in herbal remedies to treat respiratory conditions such as asthma, coughs, and bronchitis due to their soothing properties"
                ],
                partsUsed: "Leaves, bark, fruit, seed",
                precautions: "Excessive consumption of unripe mangoes may cause throat irritation",
                precautionLevel: "moderate"
            },
            "Neem Tree": {
                uses: [
                    "Neem has natural antibacterial, antifungal, and antiviral properties, making it effective in treating skin infections, wounds, and acne",
                    "Neem is used in traditional oral care products like toothpaste and mouthwash due to its ability to reduce plaque, prevent cavities, and combat oral infections",
                    "Neem extracts can reduce inflammation and boost the immune system, helping in the treatment of conditions like arthritis and other inflammatory disorders"
                ],
                partsUsed: "Leaves, bark, seeds, oil",
                precautions: "Not recommended for pregnant women",
                precautionLevel: "moderate"
            },
            "Black Plum": {
                uses: [
                    "Black plums are high in antioxidants like anthocyanins and phenolic compounds, which help combat oxidative stress and reduce the risk of chronic diseases such as heart disease and cancer",
                    "The dietary fiber in black plums aids in promoting healthy digestion, preventing constipation, and maintaining gut health",
                    "Black plums provide essential nutrients like vitamin C, vitamin K, potassium, and iron, which support immune function, improve blood circulation, and strengthen overall health"
                ],
                partsUsed: "Fruit, seeds, bark",
                precautions: "May lower blood sugar significantly if taken with diabetes medication",
                precautionLevel: "moderate"
            },
            "Pomegranate": {
                uses: [
                    "Pomegranate seeds and peel contain potent antioxidants like punicalagins and anthocyanins, which help reduce inflammation and oxidative stress in the body, potentially lowering the risk of chronic diseases",
                    "Pomegranate peel and seeds are traditionally used to improve digestion and treat gastrointestinal issues such as diarrhea and dysentery due to their antimicrobial and anti-inflammatory effects",
                    "The active compounds in pomegranates help improve blood flow, reduce blood pressure, and lower bad cholesterol levels, contributing to better heart health and reducing the risk of cardiovascular diseases"
                ],
                partsUsed: "Seeds, peel, juice",
                precautions: "May interact with blood pressure medications",
                precautionLevel: "moderate"
            },
            "Tamarind Tree": {
                uses: [
                    "Tamarind pulp is traditionally used to relieve constipation, indigestion, and gastric issues due to its mild laxative properties and high fiber content",
                    "The leaves and pods contain compounds that help reduce inflammation and combat oxidative stress, which can be beneficial in treating inflammatory conditions",
                    "Tamarind has been used in traditional medicine to help lower fever and treat infections due to its cooling and antimicrobial properties"
                ],
                partsUsed: "Pulp, leaves, pods",
                precautions: "Consume in moderation due to acidity",
                precautionLevel: "low"
            },
            "Sacred Fig": {
                uses: [
                    "The leaves and bark of the Sacred Fig are traditionally used to treat digestive disorders such as diarrhea, dysentery, and constipation",
                    "The latex and leaves are believed to help alleviate respiratory issues like coughs, asthma, and bronchitis due to their expectorant properties",
                    "The bark and leaves possess anti-inflammatory properties and are used in traditional medicine to promote wound healing and reduce inflammation"
                ],
                partsUsed: "Leaves, bark, latex",
                precautions: "Latex may cause skin irritation in sensitive individuals",
                precautionLevel: "low"
            },
            "Banyan Tree": {
                uses: [
                    "The bark and leaves of the Banyan tree contain compounds that help reduce inflammation and promote healing of wounds. The bark is often used in traditional medicine to treat ulcers and skin infections",
                    "Extracts from the Banyan tree, particularly the aerial roots and bark, have been used traditionally to help manage blood sugar levels in diabetic patients, owing to their hypoglycemic properties",
                    "The leaves and bark are used in traditional remedies to treat respiratory issues such as coughs, asthma, and bronchitis, owing to their expectorant and anti-inflammatory effects"
                ],
                partsUsed: "Bark, aerial roots, leaves",
                precautions: "Large doses may lower blood sugar drastically",
                precautionLevel: "moderate"
            },
            "Oleander": {
                uses: [
                    "Oleander contains compounds such as oleandrin that have been studied for their potential to strengthen heart contractions and treat certain heart conditions. However, due to its toxicity, this use is highly controlled and mainly experimental",
                    "Some parts of the plant have been used traditionally to reduce inflammation and treat skin conditions or wounds",
                    "Oleander extracts have shown some antimicrobial properties against certain bacteria and fungi in laboratory studies"
                ],
                partsUsed: "Leaves, flowers (CAUTION: Highly toxic)",
                precautions: "Never consume raw - professional supervision only. All parts are poisonous.",
                precautionLevel: "high"
            }
        };

        let model, webcam, maxPredictions;
        let isCameraRunning = false;

        document.getElementById("start-button").addEventListener("click", async () => {
            if (isCameraRunning) return;
            
            const button = document.getElementById("start-button");
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span> Initializing...';

            try {
                // First check if tmImage is available
                if (typeof tmImage === 'undefined') {
                    throw new Error("AI model failed to load. Please refresh the page.");
                }

                // Step 1: Request camera permissions
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 400, height: 400, facingMode: "environment" },
                    audio: false 
                });
                
                // Step 2: Load model
                const modelURL = "https://teachablemachine.withgoogle.com/models/OmDqirep4/model.json";
                const metadataURL = "https://teachablemachine.withgoogle.com/models/OmDqirep4/metadata.json";
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                // Step 3: Setup webcam
                webcam = new tmImage.Webcam(400, 400, true);
                await webcam.setup({ stream });
                await webcam.play();
                document.getElementById("webcam-container").appendChild(webcam.canvas);
                
                // Step 4: Start prediction loop
                isCameraRunning = true;
                button.style.display = "none";
                window.requestAnimationFrame(loop);
                
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("camera-error").textContent = 
                    `Error: ${error.message}. Please allow camera access and reload.`;
                button.disabled = false;
                button.textContent = "Try Again";
            }
        });

        async function loop() {
            if (!isCameraRunning) return;
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            try {
                const prediction = await model.predict(webcam.canvas);
                let topPrediction = { className: "", probability: 0 };

                for (let i = 0; i < maxPredictions; i++) {
                    if (prediction[i].probability > topPrediction.probability) {
                        topPrediction = prediction[i];
                    }
                }

                if (topPrediction.probability > 0.7) {
                    showMedicinalInfo(topPrediction.className);
                }
            } catch (error) {
                console.error("Prediction error:", error);
            }
        }

        function showMedicinalInfo(plantName) {
            const info = plantDB[plantName];
            if (!info) return;

            let precautionClass = "";
            if (info.precautionLevel === "high") {
                precautionClass = "precaution-high";
            } else if (info.precautionLevel === "moderate") {
                precautionClass = "precaution-moderate";
            }

            let html = `
                <div class="${precautionClass}">
                    <div class="plant-name">${plantName}</div>
                    <div><strong>Medicinal Uses:</strong>
                        <ul>${info.uses.map(use => `<li>${use}</li>`).join('')}</ul>
                    </div>
                    <div><strong>Parts Used:</strong> ${info.partsUsed}</div>
                    <div><strong>Precautions:</strong> ${info.precautions}</div>
                </div>
            `;

            document.getElementById("medicinal-info").innerHTML = html;
            document.getElementById("label-container").textContent = `Identified: ${plantName}`;
        }
    </script>
</body>
</html>